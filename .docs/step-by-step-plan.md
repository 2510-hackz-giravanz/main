# タスク計画書: Step-by-Step 診断プロンプトの改善

**作成日**: 2025-10-25  
**目的**: 各質問に対して熟考させるため、Step-by-Step 方式でのプロンプトを実装する

---

## 背景と課題

### 現状の問題点
- 現在は全10問の回答を一度に送信して診断
- AIが各質問の意図を十分に考慮せずに診断している可能性
- 診断精度が不安定になる可能性がある

### 改善案
Step-by-Step 方式を導入し、AIに各質問について深く考察させる

---

## Step-by-Step 診断の設計

### アプローチ1: Chain of Thought (CoT) プロンプト
各質問について段階的に分析させる

```
1. 各質問の意図を理解する
2. 選択肢が示す念能力の系統を分析する
3. ユーザーの選択から性格傾向を推測する
4. 全体を総合して最終診断を行う
```

### アプローチ2: 質問ごとの中間スコア集計
各質問ごとにスコアを算出し、最後に統合する

```
質問1 → 中間スコア1
質問2 → 中間スコア2
...
質問10 → 中間スコア10
→ 統合 → 最終スコア + コメント
```

### アプローチ3: 2段階プロンプト
1段階目: 各回答の分析
2段階目: 総合診断

---

## アプローチの比較

### アプローチ1 (CoT) 
**メリット**:
- 1回のAPI呼び出しで完結
- コスト効率が良い
- プロンプト設計でコントロール可能
- レスポンス時間が短い

**デメリット**:
- 本当に段階的に考えているか検証困難
- 長いプロンプトになる

### アプローチ2 (中間集計)
**メリット**:
- 各質問の影響を明確に把握できる
- デバッグしやすい
- 最も精度が高い可能性

**デメリット**:
- 11回のAPI呼び出しが必要（コスト高）
- 処理時間が長くなる（10秒以上）
- 実装が複雑

### アプローチ3 (2段階)
**メリット**:
- CoTと中間集計のバランス
- 2回のAPI呼び出しで適度な精度
- デバッグ可能

**デメリット**:
- アプローチ1より複雑
- アプローチ2より精度が低い可能性

---

## 推奨アプローチ

**推奨: アプローチ1 (Chain of Thought)**

### 選定理由
1. **コスト効率**: 1回のAPI呼び出しのみ
2. **レスポンス時間**: 最も高速（2-3秒）
3. **Gemini の強み**: 長いコンテキストを扱うのが得意
4. **プロンプトエンジニアリング**: 十分な精度が期待できる
5. **ユーザー体験**: 待ち時間が短い

---

## 実装計画

### 1. Chain of Thought プロンプトの設計

**ファイル**: `api/prompts/diagnosis.py`

**プロンプト構造**:
```
System: 
  - 念能力の6系統の説明
  - 診断ルール（円環構造、特質系の例外）
  - CoT 指示（段階的に考えること）  
Human: 
  - ユーザーの回答データ（質問 + 選択肢 + 選択）
  - 「段階的に分析して診断してください」という指示
```

**CoT プロンプトの例**:
```
# 分析手順

1. **各質問の分析**
   質問1から質問10まで、それぞれについて:
   - この質問が測定している性格特性は何か？
   - ユーザーが選んだ選択肢はどの念能力系統を示唆するか？
   - この回答から読み取れる性格傾向は？

2. **パターンの抽出**
   - 全体的な傾向（どの系統の選択肢を多く選んでいるか）
   - 特徴的な回答パターン
   - 一貫性の確認

3. **スコアの算出**
   - 各系統の適性を0-100で評価
   - 円環構造のルールを適用
   - 特質系の例外処理

4. **診断コメントの作成**
   - 最も高いスコアの系統の特徴を説明
   - ユーザーの回答から読み取れた具体的な性格傾向
   - 肯定的かつ具体的なフィードバック
```

### 2. プロンプトの実装

**変更点**:
- `system_message` に CoT 指示を追加
- 段階的な思考プロセスを明示
- Few-shot examples は不要（CoTで十分）

### 3. テスト と検証

**テスト項目**:
- 既存のテストケースで動作確認
- 診断結果の一貫性チェック
- レスポンス時間の測定
- スコアの妥当性確認

---

## 実装スコープ

- ✅ Chain of Thought プロンプトの設計
- ✅ プロンプトファイルの更新 (`api/prompts/diagnosis.py`)
- ✅ テストスクリプトで検証（全4テスト成功）
- ❌ 複数回のAPI呼び出しは不要
- ❌ 中間スコアの保存は不要

---

## 実装完了レポート

### 実装内容
**日時**: 2025-10-25  
**ファイル**: `api/prompts/diagnosis.py`

### 追加した CoT プロンプトセクション

```markdown
## 分析手順（Chain of Thought）

以下の手順で段階的に分析してください:

### 1. 各質問の分析
質問1から質問10まで、それぞれについて:
- この質問が測定している性格特性は何か？
- ユーザーが選んだ選択肢はどの念能力系統を示唆するか？
- この回答から読み取れる性格傾向は？

### 2. パターンの抽出
- 全体的な傾向（どの系統の選択肢を多く選んでいるか）
- 特徴的な回答パターン
- 一貫性の確認

### 3. スコアの算出
- 各系統の適性を0-100で評価
- 円環構造のルールを適用（最も得意な系統が100、その両隣が80-60）
- 特質系の例外処理

### 4. 診断コメントの作成
- 最も高いスコアの系統の特徴を説明
- ユーザーの回答から読み取れた具体的な性格傾向
- 肯定的かつ具体的なフィードバック
```

### Human Message の変更

**変更前**:
```
上記の質問と回答を分析して、念能力の6系統の診断結果をJSON形式で返してください。
```

**変更後**:
```
上記の質問と回答を、前述の分析手順（Chain of Thought）に従って段階的に分析し、念能力の6系統の診断結果をJSON形式で返してください。
```

### テスト結果

**実行コマンド**: `.venv/bin/python test/test_diagnosis.py`

**結果**: ✅ 全テスト成功（4/4）

| テストケース | 最高スコア系統 | スコア配列 | 結果 |
|-------------|--------------|-----------|------|
| 強化系寄り | 強化系 (90) | [90, 70, 50, 40, 60, 30] | ✓ |
| 変化系寄り | 具現化系 (100) | [50, 60, 80, 70, 100, 40] | ✓ |
| 特質系寄り | 操作系 (100) | [40, 40, 20, 100, 60, 20] | ✓ |
| バランス型 | 放出系 (80) | [70, 80, 60, 70, 50, 20] | ✓ |

### 診断コメントの質

各テストケースで具体的かつ肯定的なコメントが生成されることを確認:

- **強化系**: "諦めずに努力を続ける姿勢が強く...持ち前の精神力で、更なる高みを目指しましょう。"
- **変化系**: "創造性とトリッキーなプレーを重視...柔軟な発想でチームに貢献できるでしょう。"
- **特質系**: "戦略と分析を重視...冷静な判断力と戦術眼でチームを勝利に導くでしょう。"
- **バランス型**: "仲間を大切にし...バランスの取れたオールラウンダータイプでしょう。"

---

## 期待される効果

1. **診断精度の向上**: 各質問を丁寧に分析
2. **一貫性の向上**: 体系的な思考プロセス
3. **説明可能性**: どのように診断したかが明確
4. **コスト効率**: 1回のAPI呼び出しのみ
5. **高速レスポンス**: ユーザー体験の向上
