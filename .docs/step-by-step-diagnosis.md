# タスク計画書: Step-by-Step 診断プロンプトの改善

**作成日**: 2025-10-25  
**目的**: 各質問に対して熟考させるため、Step-by-Step 方式でのプロンプトを実装する

---

## 背景と課題

### 現状の問題点
- 現在は全10問の回答を一度に送信して診断
- AIが各質問の意図を十分に考慮せずに診断している可能性
- 診断精度が不安定になる可能性がある

### 改善案
Step-by-Step 方式を導入し、AIに各質問について深く考察させる

---

## Step-by-Step 診断の設計

### アプローチ1: Chain of Thought (CoT) プロンプト
各質問について段階的に分析させる

```
1. 各質問の意図を理解する
2. 選択肢が示す念能力の系統を分析する
3. ユーザーの選択から性格傾向を推測する
4. 全体を総合して最終診断を行う
```

### アプローチ2: 質問ごとの中間スコア集計
各質問ごとにスコアを算出し、最後に統合する

```
質問1 → 中間スコア1
質問2 → 中間スコア2
...
質問10 → 中間スコア10
→ 統合 → 最終スコア + コメント
```

### アプローチ3: 2段階プロンプト
1段階目: 各回答の分析
2段階目: 総合診断

---

## アプローチの比較

### アプローチ1 (CoT) 
**メリット**:
- 1回のAPI呼び出しで完結
- コスト効率が良い
- プロンプト設計でコントロール可能
- レスポンス時間が短い

**デメリット**:
- 本当に段階的に考えているか検証困難
- 長いプロンプトになる

### アプローチ2 (中間集計)
**メリット**:
- 各質問の影響を明確に把握できる
- デバッグしやすい
- 最も精度が高い可能性

**デメリット**:
- 11回のAPI呼び出しが必要（コスト高）
- 処理時間が長くなる（10秒以上）
- 実装が複雑

### アプローチ3 (2段階)
**メリット**:
- CoTと中間集計のバランス
- 2回のAPI呼び出しで適度な精度
- デバッグ可能

**デメリット**:
- アプローチ1より複雑
- アプローチ2より精度が低い可能性

---

## 推奨アプローチ

**推奨: アプローチ1 (Chain of Thought)**

### 選定理由
1. **コスト効率**: 1回のAPI呼び出しのみ
2. **レスポンス時間**: 最も高速（2-3秒）
3. **Gemini の強み**: 長いコンテキストを扱うのが得意
4. **プロンプトエンジニアリング**: 十分な精度が期待できる
5. **ユーザー体験**: 待ち時間が短い

---

## 実装タスク

### 1. Chain of Thought プロンプトの設計

**ファイル**: `api/prompts/diagnosis.py`

**プロンプト構造**:
```
System: 念能力の説明 + 診断ルール